# GithHub Actions Workflow generated with Ghygen
# Original configuration: https://ghygen.hi-folks.dev?code=0d2aa3f4cf2f90a63cc1a71edf2f956a
name: Laravel application (Mysql)
on:
  pull_request:
    branches:
      - master
      - develop
      - feature/*

jobs:
  laravel-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: server
    strategy:
      matrix:
        operating-system: [ubuntu-latest]
        php-versions: [ '7.4' ]
        dependency-stability: [ 'prefer-none' ]

        laravel: [ '8.*' ]
        include:
          - laravel:  8.*

    name: P${{ matrix.php-versions }} - Laravel${{ matrix.laravel }}

    steps:
      - uses: actions/checkout@v2
      - name: Create alias
      - run: alias sail='[ -f sail ] && bash sail || bash vendor/bin/sail'
      - name: sail up
        run: docker-compose up -d larave.test mysql.test
      - name: composer install
        run: sail composer install
      - name: Generate key
        run: sail artisan key:generate
      - name: Directory Permissions
        run:  docker-compose exec laravel.test chmod -R 777 storage bootstrap/cache
      - name: Run Migrations
        run: sail artisan migrate

      # Code quality
      - name: Execute tests (Unit and Feature tests) via PHPUnit
        run: sail test --testdox


      - uses: symfonycorp/security-checker-action@v2

      - name: Execute Code Sniffer via phpcs
        run: |
          docker-compose exec laravel.test vendor/bin/phpcs --standard=PSR12 app

      - name: Execute Code Static Analysis (PHP Stan + Larastan)
        run: |
          docker-compose exec laravel.test vendor/bin/phpstan analyse app -c ./vendor/nunomaduro/larastan/extension.neon  --level=4 --no-progress